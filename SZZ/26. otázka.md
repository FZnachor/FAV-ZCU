# Správa hlavní paměti, metody přidělování paměti, princip stránkování

## Správa hlavní paměti

**Ideál programátora**
- nekonečně velká paměť, rychlá, levná a zároveň perzistentní
- bohužel neexistuje

**Reálný počítač** - hierarchie počítače
- registry CPU
- cache paměť CPU
- operační paměť RAM
- disky

**Správce paměti**
- udržuje informaci, které části paměti se používají a které jsou volné
- **alokuje paměť procesům** podle potřeby - funkce **malloc** v C, volání sbrk
- **zařazuje paměť do volné paměti** po uvolnění procesem - funkce **free** v C

**Modul pro správu paměti**
- informace o přidělené paměti, která část je pridělitelná (a kterému procesu)
- přidělení paměti na žádost, odebrání paměti procesu
- **ochrana paměti**, přístup k paměti jiného procesu, přístup k paměti OS

**Poznámka k pointerům**
- získaný ukazatel **obsahuje virtuální adresu**, tj. **není to přímo adresa do fyzické paměti** (RAM), virtuální adresa se uvnitř procesoru **převede na fyzickou adresu** (s využitím tabulky stránek atd.)

## Metody přidělování paměti

**Virtuální paměť**
- program může být větší než dostupná fyzická paměť
- **překrývání** (overlays)
	- program rozdělen na moduly, postupně se spouštějí (od 0, po skončení 1, ...)
	- zavádění modulů
		- více překryvných modulů + data v paměti současně
		- dle potřeby (nejen 0, 1, 2, ...)
		- mechanismus odkládání (jako odkládání procesů)
	- zavádění modulů zařizuje OS
	- rozdělení programů i dat na části navrhuje programátor
- chceme, aby **ve skutečné paměti** byla realizována **pouze část** adresního prostoru, **zbytek může být odložen na disk**
- pokud **je požadovaná část** virtuálního paměťového prostoru **ve fyzické paměti**, MMU **převede virtuální adresu na fyzickou**
- pokud **není ve fyzické paměti**, OS ji musí **načíst z disku** (I/O operace, zablokování)
- většina systémů virtuální pamětí používá **stránkování**

**MMU** (Memory Management Unit)
- jednotka správy paměti, uvnitř CPU
- dva registry - **báze** (počáteční adresa) a **limit** (velikost oblasti)
- převádí virtuální adresu na fyzickou adresu
- kontroluje, zda není adresa větší než limit a zajišťuje dynamickou relokaci

## Stránkování (paging)

- program používá virtuální adresy - ta obsahuje **číslo stránky** a **offset**
- zjištění, zda je požadovaná adresa v paměti
	- **ANO** - převod virtuální adresy na fyzickou
	- **NE** - potřeba načíst paměť z disku

**Důležité pojmy**
- **VAP** - stránky (pages) pevné velikosti (nejčastěji 4 KB)
- **fyzická paměť** - **rámce** (page frames) stejné velikosti jako stránky
	- rámec může obsahovat právě jednu stránku

**Tabulka stránek**
- na známém místě v paměti (hodnota registru CR3)
- každý proces má vlastní TS, součást PCB - informace, kde tabulka leží
- poskytuje **mapování virtuálních stránek** na **fyzické rámce**
- řeší relokace a ochrany
	- v tabulce pouze stránky, kam má proces přístup - jinam se nedostane
- přepnutí na jiný proces
	- MMU přepne na jinou tabulku stránek

**Údaje v tabulce stránek**
- **číslo rámce**
	- udává rámec v RAM, kde je stránka uložena
- **příznak platnosti**
	- říká, jestli je stránka v RAM
- **příznak ochrany**
	- jestli je stránka pro čtení nebo i zápis (př. data rw, kód rx)
- **bit modifikace** (dirty)
	- pokud byla stránka modifikována (zápis), je potřeba ji zaktualizovat ve swapu
		- při odložení bude potřeba ji znovu zapsat
- **bit referenced**
	- zda bylo ke stránce v poslední době přistoupeno
	- slouží pro page replacement algoritmy
- další údaje: bit caching, adresa ve swapu, ...

**Výpadek stránky**
- stránka **není mapována**
- výpadek stránky **způsobí výjimku** - zachycena OS pomocí přerušení
- OS **iniciuje zavádění** stránky a **přepne na jiný proces**
- po načtení stránky **z disku** do **rámce** OS upraví mapování (tabulku stránek), proces může pokračovat (provedení instukce, která způsobila výpadek)
+ **vnější fragmentace** - nepřidělené úseky paměti (při stránkování nenastává)
+ **vnitřní fragmentace** - část přidělené oblasti ve stránce nevyužita
	- průměrně prázdná polovina poslední stránky procesu

Poznámky
- **čisté stránkování** - bez odkládací oblasti (swapu)
- OS udržuje
	- 1 tabulka rámců
	- tabulku stránek pro každý proces

**Tabulka rámců**
- pro správu fyzické paměti RAM
- informace, které rámce jsou volné a obsazené

**Rychlost převodu VA -> FA**
- TLB (Translation Look-aside Buffer) - HW cache
- vstup **číslo stránky**, výstup **číslo rámce** nebo **neví**
- zpomalení jen o 5 až 10 %
- přepnutí kontextu = vymazání cache - pomalý přístup, než se naplní